<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>[[${pageTitle}]]</title>
  <link rel="stylesheet" th:href="@{/css/styleUserForm.css}" />
</head>
<body>

  <div class="container-fluid">
  <div class="text-center"><h2>[[${pageTitle}]]</h2></div>

  <form th:action="@{/users/save}" method="post" th:object="${user}"
      style="max-width: 500px; margin: 0 auto;">
    <input type="hidden" th:field="*{id}">
    <div class="border border-secondary rounded p-3">
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Username:</label>
        <div class="col-sm-8">
            <input type="text" id="userName" th:field="*{userName}" class="form-control" maxlength="45" onkeyup="validateUsername()" required/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Password:</label>
        <div class="col-sm-8">
          <input type="password" th:field="*{password}" class="form-control" minlength="5" maxlength="45"  required/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Full Name:</label>
        <div class="col-sm-8">
          <input type="text" id="fullname" th:field="*{full_name}" class="form-control" maxlength="45" onkeyup="validateFullname()" required/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Role:</label>
        <div class="col-sm-8">
          <select th:field="*{role}" class="form-select" aria-label="Default select example">
            <option value="STUD">Μαθητής</option>
            <option value="PROF">Καθηγητής</option>
          </select>
        </div>
      </div>
      <div id="student">
        <div class="form-group row">
          <label class="col-sm-4 col-form-label">Average Grade:</label>
          <div class="col-sm-8">
            <input id="avg_grade" type="text" th:field="*{avg_grade}" class="form-control" maxlength="15" onkeyup="validateInput()"/>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-sm-4 col-form-label">Remain Courses:</label>
          <div class="col-sm-8">
            <input id="remain_courses" type="text" th:field="*{remain_courses}" class="form-control" maxlength="45" onkeyup="validateInput()"/>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-sm-4 col-form-label">Years Left:</label>
          <div class="col-sm-8">
            <input id="years" type="text" th:field="*{years}" class="form-control" maxlength="15" onkeyup="validateInput()"/>
          </div>
        </div>
      </div>
      <div id="prof" style="display: none">
        <div class="form-group row">
          <label class="col-sm-4 col-form-label">Speciality:</label>
          <div class="col-sm-8">
            <input id="speciality" type="text" th:field="*{speciality}" class="form-control" maxlength="15" />
          </div>
        </div>
      </div>
      <div class="form-group row">
        <input type="hidden" th:field="*{enabled}">
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary m-2">Αποθήκευση</button>
        <button type="button" class="btn btn-secondary m-2" onclick="window.location.href='/'">Ακύρωση</button>
      </div>
    </div>

  </form>
  </div>
  <script>
    $(function() {

      $("#role").change(function () {
        var role = this.value;
        if (role == "STUD") {
          $("#student").show();
          $("#prof").hide();
          $('#speciality').val('');
          $("speciality").prop('required',false);
          $("avg_grade").prop('required',true);
          $("remain_courses").prop('required',true);
          $("years").prop('required',true);
        }else{
          $("#student").hide();
          $("#prof").show();
          $('#remain_courses').val('');
          $('#avg_grade').val('');
          $('#years').val('');
          $("speciality").prop('required',true);
          $("avg_grade").prop('required',false);
          $("remain_courses").prop('required',false);
          $("years").prop('required',false);
        };
      });

    });

    function validateInput() {
      var avg_grade = document.getElementById("avg_grade");
      var remain_courses = document.getElementById("remain_courses");
      var years = document.getElementById("years");
      avg_grade.value = avg_grade.value.replace(/[^0-9\.]/g, '');
      remain_courses.value = remain_courses.value.replace(/[^0-9]/g, '');
      years.value = years.value.replace(/[^0-9]/g, '');

      if (avg_grade.value > 10 || avg_grade.value < 0) {
        alert("Ο μέγιστος βαθμός είναι 10 και ο ελάχιστος 0")
        $('#avg_grade').val("");
      }
    }

    function validateUsername() {
      setTimeout(() => {
        var uname = $('#userName').val();
        if(uname=="anonymousUser"){
          alert("Αυτό το username απαγορεύεται!")
          $('#userName').val("");
        }else{
          $.ajax({
            type: "POST",
            url: "/users/exist/"+uname,
            success: function(msg){
              console.log(msg);
              if(msg=="Ναι"){

                alert("Το username υπάρχει ήδη!")
                $('#userName').val("");
              }
            }
          });
        }
      }, 2000);
    };

    function validateFullname() {
      setTimeout(() => {
        var fname = $('#fullname').val();
        if(fname=="anonymousUser"){
          alert("Αυτό το ονοματεπώνυμο απαγορεύεται!")
          $('#fullname').val("");
        }else {
          $.ajax({
            type: "POST",
            url: "/users/existFullname/" + fname,
            success: function (msg) {
              console.log(msg);
              if (msg == "Ναι") {
                alert("Το ονοματεπώνυμο υπάρχει ήδη!")
                $('#fullname').val("");
              }
            }
          });
        }
      }, 2000);
    };

  </script>
</body>
</html>